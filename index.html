<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clearview Dashboard</title>
    <meta name="apple-mobile-web-app-title" content="Clearview">
    <meta name="application-name" content="Clearview">
    <link rel="shortcut icon" href="favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="apple-touch-icon" href="app-icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#060608">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #060608;
            --card-bg: #0f0f12;
            --card-border: #1e1e24;
            --accent: #c9a84c;
            --accent-light: #f0cc76;
            --accent-dim: rgba(201,168,76,0.1);
            --text-main: #f0ede8;
            --text-sec: #7a7880;
            --text-muted: #4a4855;
            --success: #4caf82;
            --danger: #e05555;
            --c-rf:#c9a84c;--c-reserva:#e8cc88;--c-rv:#f0ede8;
            --c-imov:#aaaaaa;--c-cripto:#666677;--c-inter:#3a3a4a;--c-outros:#7a5c1e;
        }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'DM Sans',sans-serif;outline:none;-webkit-tap-highlight-color:transparent;}
        body{background:var(--bg);color:var(--text-main);overflow-x:hidden;}

        /* SPLASH */
        #splash{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;flex-direction:column;justify-content:center;align-items:center;}
        .splash-logo{opacity:0;transform:scale(0.85);animation:splashLogoIn 0.9s cubic-bezier(0.16,1,0.3,1) 0.3s forwards;}
        .splash-logo img{height:44px;}
        .splash-greeting{margin-top:36px;text-align:center;}
        .splash-ola{font-size:0.8rem;font-weight:300;color:var(--text-muted);opacity:0;animation:fadeUp 0.6s ease 1.1s forwards;letter-spacing:4px;text-transform:uppercase;}
        .splash-nome{font-family:'Playfair Display',serif;font-size:3rem;font-weight:700;color:var(--text-main);opacity:0;animation:fadeUp 0.8s cubic-bezier(0.16,1,0.3,1) 1.4s forwards;line-height:1.1;}
        .splash-nome span{color:var(--accent);}
        .splash-line{width:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);margin-top:22px;animation:lineExpand 0.8s ease 2.1s forwards;}
        .splash-tagline{font-size:0.68rem;color:var(--text-muted);letter-spacing:3px;text-transform:uppercase;opacity:0;animation:fadeUp 0.6s ease 2.5s forwards;margin-top:18px;}
        #splash.exit{animation:splashExit 0.8s cubic-bezier(0.7,0,0.84,0) forwards;}
        @keyframes splashLogoIn{to{opacity:1;transform:scale(1);}}
        @keyframes fadeUp{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
        @keyframes lineExpand{to{width:150px;}}
        @keyframes splashExit{0%{opacity:1;transform:scale(1);}100%{opacity:0;transform:scale(1.1);pointer-events:none;}}

        /* APP */
        #app{opacity:0;transition:opacity 0.5s ease 0.1s;}
        #app.visible{opacity:1;}

        /* NAVBAR */
        .navbar{position:fixed;top:0;left:0;right:0;background:rgba(6,6,8,0.94);backdrop-filter:blur(20px);padding:13px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--card-border);z-index:100;}
        .logo-img{height:28px;display:block;opacity:0.9;}
        .navbar-right{display:flex;align-items:center;gap:10px;}
        .sync-status{font-size:0.62rem;color:var(--text-muted);transition:color 0.3s;letter-spacing:0.5px;}
        .hamburger{font-size:1.2rem;background:none;border:none;color:var(--text-sec);cursor:pointer;padding:4px;}

        /* SIDENAV */
        .sidenav{height:100%;width:0;position:fixed;z-index:200;top:0;right:0;background:#0c0c0f;overflow-x:hidden;transition:0.3s cubic-bezier(0.4,0,0.2,1);padding-top:60px;border-left:1px solid var(--card-border);}
        .sidenav a{padding:14px 28px;text-decoration:none;font-size:0.88rem;color:var(--text-sec);display:flex;align-items:center;gap:10px;transition:0.2s;}
        .sidenav a:hover{color:var(--accent);background:var(--accent-dim);}
        .sidenav .closebtn{position:absolute;top:8px;right:20px;font-size:26px;color:var(--text-muted);}
        .menu-title{padding:0 28px;font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px;letter-spacing:2px;}
        .overlay-bg{position:fixed;display:none;inset:0;background:rgba(0,0,0,0.7);z-index:150;backdrop-filter:blur(2px);}

        /* CONTENT */
        .content{padding:20px;padding-top:74px;padding-bottom:60px;max-width:580px;margin:0 auto;}

        /* MONTH HEADER */
        .month-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;margin-top:6px;}
        .month-label{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--text-main);}
        .month-sub{font-size:0.68rem;color:var(--text-muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px;}
        .month-nav{display:flex;gap:6px;}
        .month-nav button{background:var(--card-bg);border:1px solid var(--card-border);color:var(--text-sec);width:32px;height:32px;border-radius:8px;font-size:1rem;cursor:pointer;transition:0.2s;}
        .month-nav button:active{background:var(--accent-dim);color:var(--accent);}

        /* TABS */
        .tabs{display:flex;gap:4px;margin-bottom:18px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:4px;}
        .tab-btn{flex:1;padding:9px 4px;border:none;background:none;color:var(--text-muted);font-size:0.72rem;border-radius:8px;cursor:pointer;transition:0.2s;letter-spacing:0.3px;font-weight:500;}
        .tab-btn.active{background:var(--accent);color:#1a1200;font-weight:700;}
        .tab-content{display:none;}
        .tab-content.active{display:block;}

        /* CARD */
        .card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:18px;padding:20px;margin-bottom:14px;box-shadow:0 2px 24px rgba(0,0,0,0.35);}
        .card-title{font-size:0.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--text-muted);margin-bottom:14px;border-bottom:1px solid var(--card-border);padding-bottom:11px;display:flex;justify-content:space-between;align-items:center;}
        .card-title-accent{color:var(--accent);}

        /* RENDA */
        .renda-total-box{background:linear-gradient(135deg,rgba(201,168,76,0.07),rgba(201,168,76,0.02));border:1px solid rgba(201,168,76,0.18);border-radius:14px;padding:18px 20px;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center;}
        .renda-total-label{font-size:0.65rem;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;}
        .renda-total-val{font-family:'Playfair Display',serif;font-size:2.1rem;font-weight:700;color:var(--accent-light);}
        .renda-entries-count{font-size:0.68rem;color:var(--text-muted);}
        .btn-add-renda{width:100%;background:var(--accent-dim);border:1px dashed rgba(201,168,76,0.25);color:var(--accent);padding:13px;border-radius:12px;font-size:0.85rem;font-weight:600;cursor:pointer;transition:0.2s;display:flex;align-items:center;justify-content:center;gap:8px;}
        .btn-add-renda:active{background:rgba(201,168,76,0.18);}
        .renda-list{margin-top:12px;display:flex;flex-direction:column;gap:7px;}
        .renda-item{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.02);border:1px solid var(--card-border);border-radius:10px;padding:11px 13px;animation:fadeUp 0.3s ease;}
        .renda-item-left{flex:1;}
        .renda-item-cat{font-size:0.6rem;color:var(--accent);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:2px;}
        .renda-item-desc{font-size:0.8rem;color:var(--text-sec);}
        .renda-item-val{font-weight:600;color:var(--success);font-size:0.88rem;white-space:nowrap;margin-left:10px;}
        .renda-item-del{background:none;border:none;color:var(--text-muted);font-size:0.9rem;cursor:pointer;padding:4px 6px;margin-left:4px;transition:0.2s;border-radius:6px;}
        .renda-item-del:active{color:var(--danger);}

        /* INPUTS */
        .input-group{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;background:rgba(255,255,255,0.025);padding:10px 14px;border-radius:10px;border:1px solid transparent;transition:border-color 0.2s;}
        .input-group:focus-within{border-color:rgba(201,168,76,0.2);}
        .input-label{font-size:0.8rem;color:var(--text-sec);}
        .money-input{background:transparent;border:none;color:var(--text-main);font-weight:600;text-align:right;font-size:0.88rem;width:130px;}
        .money-input:focus{color:var(--accent);}

        /* SALDO */
        .saldo-box{border-radius:14px;padding:16px 20px;margin-top:4px;display:flex;justify-content:space-between;align-items:center;}
        .saldo-box.positivo{background:rgba(76,175,130,0.07);border:1px solid rgba(76,175,130,0.18);}
        .saldo-box.negativo{background:rgba(224,85,85,0.07);border:1px solid rgba(224,85,85,0.18);}
        .saldo-label{font-size:0.65rem;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:2px;}
        .saldo-val{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;}

        /* CAT */
        .cat-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:rgba(255,255,255,0.02);border-radius:10px;margin-bottom:4px;cursor:pointer;border:1px solid var(--card-border);transition:all 0.2s;}
        .cat-header:active{transform:scale(0.99);}
        .cat-title{font-size:0.83rem;color:var(--text-main);display:flex;align-items:center;gap:8px;}
        .cat-total{font-size:0.83rem;color:var(--text-main);font-weight:600;}
        .arrow{font-size:0.58rem;transition:transform 0.3s;color:var(--text-muted);}
        .cat-header.active .arrow{transform:rotate(180deg);}
        .cat-header.active{border-color:rgba(201,168,76,0.25);background:var(--accent-dim);}
        .cat-content{display:none;padding:8px 4px 4px;margin-bottom:10px;border-left:1px solid rgba(201,168,76,0.12);margin-left:12px;padding-left:12px;}
        .cat-content.show{display:block;animation:slideDown 0.22s ease;}
        @keyframes slideDown{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}

        /* EXPENSE ROWS */
        .expense-row{display:grid;grid-template-columns:1.5fr 1fr 0.8fr auto;gap:5px;align-items:center;margin-bottom:9px;border-bottom:1px solid rgba(255,255,255,0.04);padding-bottom:7px;}
        .expense-row:last-child{border-bottom:none;}
        .lbl-input{background:transparent;border:none;color:var(--text-sec);font-size:0.76rem;width:100%;border-bottom:1px solid transparent;transition:0.2s;}
        .lbl-input:focus{border-bottom:1px solid var(--accent);color:var(--text-main);}
        .box-input,.pay-select{background:rgba(255,255,255,0.04);color:var(--text-main);border:1px solid var(--card-border);border-radius:6px;font-size:0.7rem;padding:6px 3px;width:100%;text-align:center;font-weight:600;appearance:none;-webkit-appearance:none;}
        .box-input:focus,.pay-select:focus{border-color:var(--accent);}
        .pay-select{font-weight:400;color:var(--text-sec);}
        .btn-del-row{background:none;border:none;color:var(--text-muted);font-size:0.9rem;cursor:pointer;padding:3px 5px;border-radius:5px;transition:0.2s;line-height:1;}
        .btn-del-row:active{color:var(--danger);}
        .btn-add-row{background:none;border:1px dashed rgba(255,255,255,0.08);color:var(--text-muted);font-size:0.72rem;padding:7px 14px;border-radius:8px;cursor:pointer;transition:0.2s;margin-top:4px;width:100%;}
        .btn-add-row:active{border-color:var(--accent);color:var(--accent);}

        /* QUICK ADD BTN */
        .btn-quick-add-inline{background:var(--accent-dim);color:var(--accent);border:1px solid rgba(201,168,76,0.2);padding:4px 12px;border-radius:8px;font-size:0.7rem;font-weight:600;cursor:pointer;transition:0.2s;}
        .btn-quick-add-inline:active{background:rgba(201,168,76,0.18);}
        .btn-reset{width:100%;background:rgba(255,255,255,0.02);border:1px solid var(--card-border);color:var(--text-muted);padding:10px;border-radius:10px;font-size:0.72rem;margin-top:10px;cursor:pointer;transition:0.2s;}
        .btn-reset:active{background:rgba(224,85,85,0.07);color:var(--danger);}

        /* ATIVOS */
        .chart-donut-container{position:relative;height:195px;margin:6px 0;}
        .total-center{text-align:center;margin-top:-4px;margin-bottom:14px;}
        .total-center h3{font-family:'Playfair Display',serif;font-size:1.9rem;color:var(--text-main);}
        .total-center span{color:var(--text-muted);font-size:0.65rem;letter-spacing:1.5px;text-transform:uppercase;}
        .meta-wrapper{margin-top:14px;}
        .progress-track{background:rgba(255,255,255,0.05);height:5px;border-radius:3px;overflow:hidden;margin:7px 0;}
        .progress-fill{height:100%;background:linear-gradient(90deg,#7a5c1e,var(--accent));width:0%;transition:width 1.2s cubic-bezier(0.4,0,0.2,1);}
        .meta-info{display:flex;justify-content:space-between;align-items:center;font-size:0.72rem;color:var(--text-muted);}
        .meta-input-inline{background:none;border:none;color:var(--text-muted);width:100px;text-align:right;font-size:0.72rem;}

        /* HIST√ìRICO */
        .historico-card{margin-bottom:8px;}
        .historico-mes-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:14px;cursor:pointer;transition:0.2s;}
        .historico-mes-header.open{border-radius:14px 14px 0 0;border-bottom-color:transparent;}
        .historico-mes-header:active{background:rgba(255,255,255,0.02);}
        .hist-mes-nome{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;}
        .hist-mes-ano{font-size:0.65rem;color:var(--text-muted);margin-left:6px;}
        .hist-mes-right{text-align:right;}
        .hist-mes-saldo{font-size:0.82rem;font-weight:600;}
        .hist-mes-arrow{font-size:0.58rem;color:var(--text-muted);margin-left:8px;transition:transform 0.3s;display:inline-block;}
        .historico-mes-header.open .hist-mes-arrow{transform:rotate(180deg);}
        .historico-body{display:none;background:var(--card-bg);border:1px solid var(--card-border);border-top:none;border-radius:0 0 14px 14px;padding:12px 16px;}
        .historico-body.show{display:block;animation:slideDown 0.22s ease;}
        .hist-section-title{font-size:0.6rem;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase;margin:10px 0 6px;padding-bottom:6px;border-bottom:1px solid var(--card-border);}
        .hist-item{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.8rem;}
        .hist-item:last-child{border-bottom:none;}
        .hist-item-left{flex:1;}
        .hist-item-cat{font-size:0.58rem;color:var(--accent);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:1px;}
        .hist-item-desc{color:var(--text-sec);}
        .hist-item-pos{color:var(--success);font-weight:600;}
        .hist-item-neg{color:var(--danger);font-weight:600;}
        .hist-resumo{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:10px;}
        .hist-resumo-item{text-align:center;}
        .hist-resumo-label{font-size:0.58rem;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;}
        .hist-resumo-val{font-size:0.82rem;font-weight:600;}
        .empty-hist{text-align:center;padding:48px 20px;color:var(--text-muted);font-size:0.82rem;}
        .empty-hist-icon{font-size:2.2rem;margin-bottom:10px;opacity:0.35;}

        /* CALCULADORA */
        .calc-row{display:flex;gap:10px;margin-bottom:10px;}
        .col-half{flex:1;}
        .calc-label{display:block;font-size:0.7rem;color:var(--text-muted);margin-bottom:6px;letter-spacing:0.5px;}
        .custom-select{background:rgba(255,255,255,0.06);border:1px solid var(--card-border);color:var(--text-sec);padding:2px 6px;border-radius:5px;font-size:0.65rem;margin-left:4px;}
        .calc-input-styled{width:100%;background:rgba(255,255,255,0.03);border:1px solid var(--card-border);color:var(--text-main);padding:11px 12px;border-radius:10px;font-size:0.93rem;transition:0.2s;}
        .calc-input-styled:focus{border-color:rgba(201,168,76,0.35);}
        .btn-calc{width:100%;background:var(--accent);color:#1a1200;border:none;padding:13px;border-radius:10px;font-weight:700;font-size:0.88rem;cursor:pointer;letter-spacing:0.5px;}
        .btn-calc:active{opacity:0.85;}
        .projection-container{margin-top:22px;display:none;border-top:1px solid var(--card-border);padding-top:18px;}
        .chart-line-container{height:235px;width:100%;margin-top:14px;}
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
        .stat-box{background:rgba(255,255,255,0.02);border:1px solid var(--card-border);padding:11px;border-radius:10px;text-align:center;}
        .stat-val{display:block;font-weight:700;color:var(--text-main);font-size:0.85rem;margin-bottom:2px;}
        .stat-lbl{font-size:0.6rem;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase;}

        /* MODAIS */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:300;display:none;justify-content:center;align-items:flex-end;backdrop-filter:blur(4px);}
        .modal-content{background:#111115;width:100%;max-width:520px;border-radius:22px 22px 0 0;padding:24px 22px;border-top:1px solid var(--card-border);animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1) forwards;}
        @keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
        @keyframes slideDownModal{from{transform:translateY(0);}to{transform:translateY(100%);}}
        .modal-title{color:var(--text-main);font-family:'Playfair Display',serif;font-size:1.15rem;margin-bottom:18px;}
        .modal-input-lg{width:100%;background:transparent;border:none;border-bottom:2px solid var(--accent);color:var(--text-main);font-size:2rem;text-align:center;font-weight:700;margin-bottom:16px;padding-bottom:8px;font-family:'Playfair Display',serif;}
        .modal-input-lg::placeholder{color:var(--text-muted);}
        .modal-input-desc{width:100%;background:rgba(255,255,255,0.03);border:1px solid var(--card-border);color:var(--text-main);padding:12px 14px;border-radius:10px;font-size:0.88rem;margin-bottom:10px;transition:0.2s;}
        .modal-input-desc:focus{border-color:rgba(201,168,76,0.35);}
        .modal-select{width:100%;background:rgba(255,255,255,0.03);color:var(--text-main);border:1px solid var(--card-border);padding:12px 14px;border-radius:10px;margin-bottom:10px;font-size:0.88rem;appearance:none;-webkit-appearance:none;}
        .btn-confirm-add{width:100%;background:var(--accent);color:#1a1200;font-weight:700;padding:14px;border-radius:12px;border:none;font-size:0.92rem;margin-top:4px;letter-spacing:0.5px;cursor:pointer;}
        .btn-confirm-add:active{opacity:0.85;}
        .btn-close-modal{background:none;border:none;color:var(--text-muted);width:100%;padding:11px;margin-top:4px;font-size:0.82rem;cursor:pointer;}

        footer{text-align:center;font-size:0.62rem;color:var(--text-muted);margin-top:36px;opacity:0.45;letter-spacing:1px;padding-bottom:20px;}
    </style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
    <div class="splash-logo"><img src="logo.png" alt="Clearview"></div>
    <div class="splash-greeting">
        <div class="splash-ola">Ol√°,</div>
        <div class="splash-nome"><span>Fernando</span> Sanga</div>
    </div>
    <div class="splash-line"></div>
    <div class="splash-tagline">Clearview Capital ¬∑ Dashboard</div>
</div>

<!-- APP -->
<div id="app">
    <nav class="navbar">
        <img src="logo.png" alt="Clearview" class="logo-img">
        <div class="navbar-right">
            <span id="sync-status" class="sync-status"></span>
            <button class="hamburger" onclick="openNav()">&#9776;</button>
        </div>
    </nav>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <div class="menu-title">Atendimento</div>
        <a href="https://wa.me/44991293357" target="_blank"><span>üì±</span> WhatsApp</a>
        <a href="mailto:contato@clearviewcapital.com.br"><span>‚úâÔ∏è</span> E-mail</a>
    </div>
    <div id="overlay" class="overlay-bg" onclick="closeNav()"></div>

    <div class="content">
        <div class="month-header">
            <div>
                <div class="month-label" id="monthLabel">‚Äî</div>
                <div class="month-sub">Refer√™ncia mensal</div>
            </div>
            <div class="month-nav">
                <button onclick="changeMonth(-1)">‚Äπ</button>
                <button onclick="changeMonth(1)">‚Ä∫</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('fluxo')">Fluxo</button>
            <button class="tab-btn" onclick="switchTab('ativos')">Ativos</button>
            <button class="tab-btn" onclick="switchTab('historico')">Hist√≥rico</button>
            <button class="tab-btn" onclick="switchTab('projecao')">Proje√ß√£o</button>
        </div>

        <!-- TAB FLUXO -->
        <div id="tab-fluxo" class="tab-content active">
            <div class="card">
                <div class="card-title">
                    <span>Renda Mensal</span>
                    <span class="card-title-accent" id="mesRefLabel"></span>
                </div>
                <div class="renda-total-box">
                    <div>
                        <div class="renda-total-label">Total Recebido</div>
                        <div class="renda-total-val" id="rendaTotal">R$ 0,00</div>
                    </div>
                    <div>
                        <div class="renda-entries-count" id="rendaCount">0 lan√ßamentos</div>
                    </div>
                </div>
                <div class="renda-list" id="rendaList"></div>
                <button class="btn-add-renda" onclick="openRendaModal()"><span>Ôºã</span> Adicionar Renda</button>
            </div>

            <div class="card">
                <div class="card-title">
                    <span>Gastos</span>
                    <button class="btn-quick-add-inline" onclick="openAddModal()">+ R√°pido</button>
                </div>
                <div id="gastos-container"></div>
                <div class="saldo-box positivo" id="saldoBox">
                    <div>
                        <div class="saldo-label">Sobra de Caixa</div>
                        <div class="saldo-val" id="valInvest">R$ 0,00</div>
                    </div>
                    <div style="font-size:1.5rem;opacity:0.25" id="saldoIcon">üí∞</div>
                </div>
                <button class="btn-reset" onclick="resetFlow()">Limpar M√™s</button>
            </div>
        </div>

        <!-- TAB ATIVOS -->
        <div id="tab-ativos" class="tab-content">
            <div class="card">
                <div class="card-title"><span>Meus Ativos</span><span id="headerTotal" style="color:var(--text-main)">R$ 0,00</span></div>
                <div class="chart-donut-container"><canvas id="assetsChart"></canvas></div>
                <div class="total-center"><span>Patrim√¥nio Total</span><h3 id="displayTotal">R$ 0,00</h3></div>
                <div class="input-group"><span class="input-label" style="border-left:3px solid var(--c-rf);padding-left:8px">Renda Fixa</span><input type="tel" class="money-input" id="rf" onkeyup="mask(this);updateAssets()"></div>
                <div class="input-group"><span class="input-label" style="border-left:3px solid var(--c-reserva);padding-left:8px">Reserva Emerg√™ncia</span><input type="tel" class="money-input" id="reserva" onkeyup="mask(this);updateAssets()"></div>
                <div class="input-group"><span class="input-label" style="border-left:3px solid var(--c-rv);padding-left:8px">Renda Vari√°vel</span><input type="tel" class="money-input" id="rv" onkeyup="mask(this);updateAssets()"></div>
                <div class="input-group"><span class="input-label" style="border-left:3px solid var(--c-imov);padding-left:8px">Im√≥veis/FIIs</span><input type="tel" class="money-input" id="imoveis" onkeyup="mask(this);updateAssets()"></div>
                <div class="input-group"><span class="input-label" style="border-left:3px solid var(--c-cripto);padding-left:8px">Criptomoedas</span><input type="tel" class="money-input" id="cripto" onkeyup="mask(this);updateAssets()"></div>
                <div class="input-group"><span class="input-label" style="border-left:3px solid var(--c-inter);padding-left:8px">Internacional</span><input type="tel" class="money-input" id="internacional" onkeyup="mask(this);updateAssets()"></div>
                <div class="input-group"><span class="input-label" style="border-left:3px solid var(--c-outros);padding-left:8px">Outros</span><input type="tel" class="money-input" id="outros_ativos" onkeyup="mask(this);updateAssets()"></div>
                <div class="meta-wrapper">
                    <div class="meta-info"><span>Meta: <input type="tel" class="meta-input-inline" id="metaVal" onkeyup="mask(this);updateAssets()"></span><span id="percText">0%</span></div>
                    <div class="progress-track"><div class="progress-fill" id="progBar"></div></div>
                </div>
            </div>
        </div>

        <!-- TAB HIST√ìRICO -->
        <div id="tab-historico" class="tab-content">
            <div id="historico-container">
                <div class="empty-hist">
                    <div class="empty-hist-icon">üìÖ</div>
                    <div>Nenhum hist√≥rico ainda.<br>Os dados dos meses anteriores aparecer√£o aqui.</div>
                </div>
            </div>
        </div>

        <!-- TAB PROJE√á√ÉO -->
        <div id="tab-projecao" class="tab-content">
            <div class="card">
                <div class="card-title">Calculadora de Futuro</div>
                <div class="calc-row">
                    <div class="col-half"><span class="calc-label">Aporte Inicial</span><input type="tel" class="calc-input-styled" id="calcInit" onkeyup="mask(this);saveAllData()"></div>
                    <div class="col-half"><span class="calc-label">Aporte Mensal</span><input type="tel" class="calc-input-styled" id="calcMonth" onkeyup="mask(this);saveAllData()"></div>
                </div>
                <div class="calc-row">
                    <div class="col-half"><span class="calc-label">Taxa Juros <select id="selJuros" class="custom-select" onchange="saveAllData()"><option value="aa">a.a</option><option value="am">a.m</option></select></span><input type="number" class="calc-input-styled" id="txJuros" onkeyup="saveAllData()"></div>
                    <div class="col-half"><span class="calc-label">Infla√ß√£o <select id="selInf" class="custom-select" onchange="saveAllData()"><option value="aa">a.a</option><option value="am">a.m</option></select></span><input type="number" class="calc-input-styled" id="txInf" onkeyup="saveAllData()"></div>
                </div>
                <div class="calc-row">
                    <div class="col-half"><span class="calc-label">Per√≠odo <select id="selTempo" class="custom-select" onchange="saveAllData()"><option value="anos">Anos</option><option value="meses">Meses</option></select></span><input type="number" class="calc-input-styled" id="tempo" onkeyup="saveAllData()"></div>
                    <div class="col-half" style="display:flex;align-items:flex-end"><button class="btn-calc" onclick="calculateProjection()">Calcular</button></div>
                </div>
                <div class="projection-container" id="projContainer">
                    <h3 style="text-align:center;color:var(--text-main);font-family:'Playfair Display',serif;font-size:1.05rem;margin-bottom:12px">Proje√ß√£o</h3>
                    <div class="stats-grid">
                        <div class="stat-box"><span class="stat-lbl">Total Acumulado</span><span class="stat-val" style="color:var(--accent)" id="resFinal">--</span></div>
                        <div class="stat-box"><span class="stat-lbl">Total Investido</span><span class="stat-val" id="resInvestido">--</span></div>
                        <div class="stat-box"><span class="stat-lbl">Ganho Real</span><span class="stat-val" style="color:var(--success)" id="resJuros">--</span></div>
                        <div class="stat-box"><span class="stat-lbl">Poder de Compra</span><span class="stat-val" style="color:var(--text-sec)" id="resReal">--</span></div>
                    </div>
                    <div class="chart-line-container"><canvas id="lineChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <footer>&copy; 2026 Clearview Capital. Todos os direitos reservados.</footer>
</div>

<!-- MODAL RENDA -->
<div id="rendaModal" class="modal-overlay" onclick="if(event.target===this)closeRendaModal()">
    <div class="modal-content">
        <div class="modal-title">Nova Renda</div>
        <input type="tel" id="rendaValor" class="modal-input-lg" placeholder="R$ 0,00" inputmode="numeric" onkeyup="mask(this)">
        <select id="rendaCat" class="modal-select">
            <option value="" disabled selected>Categoria</option>
            <option value="Sal√°rio">Sal√°rio</option>
            <option value="Freelance">Freelance</option>
            <option value="Venda">Venda</option>
            <option value="Servi√ßo">Servi√ßo</option>
            <option value="Investimentos">Rendimento de Investimentos</option>
            <option value="Aluguel">Aluguel</option>
            <option value="Comiss√£o">Comiss√£o</option>
            <option value="B√¥nus">B√¥nus</option>
            <option value="Outros">Outros</option>
        </select>
        <input type="text" id="rendaDesc" class="modal-input-desc" placeholder="Descri√ß√£o (opcional)">
        <button class="btn-confirm-add" onclick="addRenda()">Adicionar</button>
        <button class="btn-close-modal" onclick="closeRendaModal()">Cancelar</button>
    </div>
</div>

<!-- MODAL GASTO R√ÅPIDO -->
<div id="addModal" class="modal-overlay" onclick="if(event.target===this)closeAddModal()">
    <div class="modal-content">
        <div class="modal-title">Gasto R√°pido</div>
        <input type="tel" id="quickValue" class="modal-input-lg" placeholder="R$ 0,00" inputmode="numeric" onkeyup="mask(this)">
        <select id="quickCat" class="modal-select" onchange="updateSubcats()">
            <option value="" disabled selected>Categoria</option>
        </select>
        <select id="quickSub" class="modal-select" disabled>
            <option value="" disabled selected>Item</option>
        </select>
        <select id="quickPay" class="modal-select">
            <option value="" disabled selected>M√©todo (Opcional)</option>
            <option>Pix</option><option>Cart√£o Cr√©dito</option><option>Cart√£o D√©bito</option><option>Boleto</option><option>Dinheiro</option>
        </select>
        <button class="btn-confirm-add" onclick="processAddExpense()">Adicionar Gasto</button>
        <button class="btn-close-modal" onclick="closeAddModal()">Cancelar</button>
    </div>
</div>

<!-- FIREBASE + JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// =============================================
// CONFIGURA√á√ÉO DO CLIENTE ‚Äî ALTERE APENAS AQUI
// =============================================
const CLIENT_ID = "fernando_sanga";
const CLIENT_NAME = "Fernando";
// =============================================

const firebaseConfig = {
    apiKey: "AIzaSyDmLOM3oS6PPHL1617j0iKtMuV2vTGylwI",
    authDomain: "clearview-4a460.firebaseapp.com",
    projectId: "clearview-4a460",
    storageBucket: "clearview-4a460.firebasestorage.app",
    messagingSenderId: "986661522432",
    appId: "1:986661522432:web:15d61bbbaad7ec3d6c9ce5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---- ESTADO GLOBAL ----
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth(); // 0-indexed
let donutChart = null, lineChart = null;
let rendaItems = []; // [{id, val, cat, desc, date}]
let gastosData = {}; // categoria -> [{id, label, val, pay}]
let rowCounters = {}; // para IDs √∫nicos
let historico = {}; // "YYYY-MM" -> {renda:[], gastos:{}, ativos:{}}
let ativosData = {};
let calcData = {};

const MESES = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const CATEGORIAS = ['Moradia','Transporte','Sa√∫de','Obriga√ß√µes','Vida Di√°ria','Entretenimento','Economias'];
const CAT_KEYS = ['moradia','transporte','saude','obrigacoes','vida','entret','economias'];

const CAT_DEFAULTS = {
    moradia: ['Aluguel/Parcela','Seguros','Conta de Luz','Conta de √Ågua','Telefone','Streaming','Internet','Eletrodom√©sticos','Melhorias','Outros'],
    transporte: ['Parcela Carro','Seguro Carro','Combust√≠vel','√înibus/App','Outros'],
    saude: ['Seguro Vida','Consulta','Dentista','Medicamentos','Veterin√°rio','Outros'],
    obrigacoes: ['D√≠vidas','Empr√©stimo Estudantil','Outros Empr√©stimos','Cart√£o de Cr√©dito','Taxas e Impostos','Outros'],
    vida: ['Supermercado','Suprimentos Pessoais','Roupas','Produtos de Limpeza','Jantar/Comer Fora','Sal√£o/Barbearia','PetShop','Outros'],
    entret: ['Filmes/Cinema','M√∫sica','Games','Show','Livros','Hobbies','Esportes','Academia','Passeios','F√©rias','Viagem','Teatro','Outros'],
    economias: ['Para Reserva','Para Investimentos','Outros']
};

// ---- HELPERS ----
const parseMoney = v => { if(!v) return 0; if(typeof v==='number') return v; const s=v.toString(); return parseFloat(s.replace(/\D/g,''))/100||0; };
const formatBRL = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
function mask(i){ let v=i.value.replace(/\D/g,''); v=(v/100).toFixed(2)+''; v=v.replace('.',','); v=v.replace(/(\d)(?=(\d{3})+(?!\d))/g,'$1.'); i.value='R$ '+v; }
function fillInput(id,val){ const el=document.getElementById(id); if(el){el.value=(val||0).toFixed(2).replace('.','')||''; mask(el);} }
function setStatus(msg,color){ const el=document.getElementById('sync-status'); if(el){el.innerText=msg;el.style.color=color;} }
function monthKey(){ return `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`; }

// ---- MONTH NAVIGATION ----
window.changeMonth = function(dir){
    // Salva m√™s atual no hist√≥rico antes de trocar
    saveHistoricoSnapshot();
    currentMonth += dir;
    if(currentMonth > 11){ currentMonth=0; currentYear++; }
    if(currentMonth < 0){ currentMonth=11; currentYear--; }
    renderMonthLabel();
    loadMonthData();
};

function renderMonthLabel(){
    document.getElementById('monthLabel').textContent = `${MESES[currentMonth]} ${currentYear}`;
    document.getElementById('mesRefLabel').textContent = MESES[currentMonth].substring(0,3).toUpperCase();
}

// ---- TABS ----
window.switchTab = function(tab){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+tab).classList.add('active');
    event.currentTarget.classList.add('active');
    if(tab==='historico') renderHistorico();
    if(tab==='ativos') { if(donutChart) donutChart.update(); }
};

// ---- GASTOS DIN√ÇMICOS ----
function initGastosData(){
    gastosData = {};
    rowCounters = {};
    CAT_KEYS.forEach((key,i) => {
        rowCounters[key] = 0;
        gastosData[key] = CAT_DEFAULTS[key].map((name,j) => ({
            id: `${key}_${j}`, label: name, val: 0, pay: ''
        }));
        rowCounters[key] = gastosData[key].length;
    });
}

function renderGastos(){
    const container = document.getElementById('gastos-container');
    container.innerHTML = '';
    CAT_KEYS.forEach((key,i) => {
        const catTotal = (gastosData[key]||[]).reduce((s,r)=>s+r.val,0);
        const isEco = key==='economias';

        const header = document.createElement('div');
        header.className = 'cat-header';
        header.id = 'cat-hdr-'+key;
        header.innerHTML = `<span class="cat-title"><span class="arrow">‚ñº</span> ${CATEGORIAS[i]}${isEco?' (Aloca√ß√£o)':''}</span><span class="cat-total" id="tot-${key}">${formatBRL(catTotal)}</span>`;
        header.onclick = () => toggleCatEl(key);
        if(isEco) header.style.borderColor='rgba(201,168,76,0.25)';
        container.appendChild(header);

        const content = document.createElement('div');
        content.className = 'cat-content';
        content.id = 'cat-'+key;
        if(isEco){ const note=document.createElement('p'); note.style.cssText='font-size:0.65rem;color:var(--text-muted);margin-bottom:8px'; note.textContent='*Estes valores n√£o descontam do saldo.'; content.appendChild(note); }

        (gastosData[key]||[]).forEach(row => {
            content.appendChild(buildRow(key, row, isEco));
        });

        const addBtn = document.createElement('button');
        addBtn.className='btn-add-row';
        addBtn.textContent='+ Adicionar linha';
        addBtn.onclick=()=>addRow(key);
        content.appendChild(addBtn);
        container.appendChild(content);
    });
    updateQuickCatSelect();
}

function buildRow(key, row, isEco){
    const div = document.createElement('div');
    div.className='expense-row';
    div.id='row-'+row.id;

    const lbl = document.createElement('input');
    lbl.type='text'; lbl.className='lbl-input'; lbl.value=row.label;
    if(key==='moradia'&&row.label==='Aluguel/Parcela'){ lbl.style.color='var(--accent)'; lbl.readOnly=true; }
    lbl.onchange=()=>{ row.label=lbl.value; saveAllData(); updateQuickCatSelect(); };
    div.appendChild(lbl);

    const val = document.createElement('input');
    val.type='tel'; val.className=`box-input ${isEco?'eco-input':'expense-input'}`;
    if(!isEco) val.dataset.cat=key;
    val.value = row.val ? (row.val*100).toFixed(0) : '';
    if(val.value) mask(val);
    val.onkeyup=()=>{ mask(val); row.val=parseMoney(val.value); updateFlow(); };
    div.appendChild(val);

    if(!isEco){
        const pay = document.createElement('select');
        pay.className='pay-select';
        pay.innerHTML='<option value="" selected disabled style="display:none"></option><option>Pix</option><option>Cart√£o Cr√©dito</option><option>Cart√£o D√©bito</option><option>Boleto</option><option>Dinheiro</option>';
        pay.value=row.pay||'';
        if(row.pay){ setTimeout(()=>pay.value=row.pay,0); }
        pay.onchange=()=>{ row.pay=pay.value; saveAllData(); };
        div.appendChild(pay);
    } else {
        div.appendChild(document.createElement('span'));
    }

    const del = document.createElement('button');
    del.className='btn-del-row'; del.textContent='√ó'; del.title='Remover';
    del.onclick=()=>removeRow(key, row.id);
    div.appendChild(del);
    return div;
}

window.addRow = function(key){
    const idx = rowCounters[key]++;
    const newRow = { id:`${key}_${idx}`, label:'', val:0, pay:'' };
    gastosData[key].push(newRow);
    const content = document.getElementById('cat-'+key);
    const addBtn = content.querySelector('.btn-add-row');
    content.insertBefore(buildRow(key, newRow, key==='economias'), addBtn);
    saveAllData();
};

window.removeRow = function(key, rowId){
    // Fica no hist√≥rico, some da tela
    const rowEl = document.getElementById('row-'+rowId);
    if(rowEl){ rowEl.style.opacity='0'; rowEl.style.transform='translateX(20px)'; rowEl.style.transition='0.2s'; setTimeout(()=>rowEl.remove(),200); }
    gastosData[key] = gastosData[key].filter(r=>r.id!==rowId);
    updateFlow();
    saveAllData();
};

window.toggleCatEl = function(key){
    const content = document.getElementById('cat-'+key);
    const header = document.getElementById('cat-hdr-'+key);
    const isOpen = content.classList.contains('show');
    document.querySelectorAll('.cat-content').forEach(c=>c.classList.remove('show'));
    document.querySelectorAll('.cat-header').forEach(h=>h.classList.remove('active'));
    if(!isOpen){ content.classList.add('show'); header.classList.add('active'); }
};

// ---- RENDA ----
window.openRendaModal = function(){
    document.getElementById('rendaModal').style.display='flex';
    document.getElementById('rendaValor').value='';
    document.getElementById('rendaCat').value='';
    document.getElementById('rendaDesc').value='';
    setTimeout(()=>document.getElementById('rendaValor').focus(),100);
};
window.closeRendaModal = function(){
    const mc=document.querySelector('#rendaModal .modal-content');
    mc.style.animation='slideDownModal 0.3s forwards';
    setTimeout(()=>{ document.getElementById('rendaModal').style.display='none'; mc.style.animation=''; },300);
};
window.addRenda = function(){
    const val = parseMoney(document.getElementById('rendaValor').value);
    const cat = document.getElementById('rendaCat').value;
    const desc = document.getElementById('rendaDesc').value;
    if(!val||!cat){ alert('Preencha o valor e a categoria.'); return; }
    const item = { id: Date.now().toString(), val, cat, desc, date: new Date().toISOString() };
    rendaItems.push(item);
    renderRendaList();
    updateFlow();
    saveAllData();
    closeRendaModal();
};

function renderRendaList(){
    const list = document.getElementById('rendaList');
    list.innerHTML='';
    rendaItems.forEach(item=>{
        const div=document.createElement('div');
        div.className='renda-item';
        div.innerHTML=`<div class="renda-item-left"><div class="renda-item-cat">${item.cat}</div><div class="renda-item-desc">${item.desc||'‚Äî'}</div></div><span class="renda-item-val">+${formatBRL(item.val)}</span><button class="renda-item-del" onclick="removeRenda('${item.id}')">√ó</button>`;
        list.appendChild(div);
    });
}

window.removeRenda = function(id){
    rendaItems = rendaItems.filter(r=>r.id!==id);
    renderRendaList();
    updateFlow();
    saveAllData();
};

// ---- FLOW UPDATE ----
window.updateFlow = function(){
    const totalRenda = rendaItems.reduce((s,r)=>s+r.val,0);
    document.getElementById('rendaTotal').textContent=formatBRL(totalRenda);
    document.getElementById('rendaCount').textContent=`${rendaItems.length} lan√ßamento${rendaItems.length!==1?'s':''}`;

    let totalDesp=0;
    CAT_KEYS.forEach(key=>{
        if(key==='economias') return;
        const catTotal=(gastosData[key]||[]).reduce((s,r)=>s+r.val,0);
        totalDesp+=catTotal;
        const el=document.getElementById('tot-'+key);
        if(el) el.textContent=formatBRL(catTotal);
    });
    const ecoTotal=(gastosData['economias']||[]).reduce((s,r)=>s+r.val,0);
    const ecoEl=document.getElementById('tot-economias');
    if(ecoEl) ecoEl.textContent=formatBRL(ecoTotal);

    const sobra = totalRenda - totalDesp;
    const investEl=document.getElementById('valInvest');
    investEl.textContent=formatBRL(sobra);
    investEl.style.color=sobra<0?'var(--danger)':'var(--success)';
    const saldoBox=document.getElementById('saldoBox');
    saldoBox.className='saldo-box '+(sobra<0?'negativo':'positivo');
    document.getElementById('saldoIcon').textContent=sobra<0?'‚ö†Ô∏è':'üí∞';
    saveAllData();
};

// ---- ATIVOS ----
window.updateAssets = function(){
    const ids=['rf','reserva','rv','imoveis','cripto','internacional','outros_ativos'];
    const vals=ids.map(id=>parseMoney(document.getElementById(id).value));
    const total=vals.reduce((a,b)=>a+b,0);
    const meta=parseMoney(document.getElementById('metaVal').value);
    document.getElementById('displayTotal').textContent=formatBRL(total);
    document.getElementById('headerTotal').textContent=formatBRL(total);
    let pct=meta>0?(total/meta)*100:0; if(pct>100)pct=100;
    document.getElementById('progBar').style.width=pct+'%';
    document.getElementById('percText').textContent=pct.toFixed(1)+'%';
    if(donutChart){ donutChart.data.datasets[0].data=vals; donutChart.update(); }
    ativosData={rf:vals[0],reserva:vals[1],rv:vals[2],imoveis:vals[3],cripto:vals[4],internacional:vals[5],outros_ativos:vals[6],meta:meta};
    saveAllData();
};

// ---- HIST√ìRICO ----
function saveHistoricoSnapshot(){
    const key = monthKey();
    const totalRenda = rendaItems.reduce((s,r)=>s+r.val,0);
    let totalDesp=0;
    CAT_KEYS.forEach(k=>{ if(k!=='economias') totalDesp+=(gastosData[k]||[]).reduce((s,r)=>s+r.val,0); });
    historico[key] = {
        year: currentYear, month: currentMonth,
        renda: JSON.parse(JSON.stringify(rendaItems)),
        gastos: JSON.parse(JSON.stringify(gastosData)),
        totalRenda, totalDesp, saldo: totalRenda-totalDesp
    };
}

function renderHistorico(){
    const container=document.getElementById('historico-container');
    const keys=Object.keys(historico).sort().reverse();
    if(!keys.length){
        container.innerHTML='<div class="empty-hist"><div class="empty-hist-icon">üìÖ</div><div>Nenhum hist√≥rico ainda.<br>Os dados dos meses anteriores aparecer√£o aqui.</div></div>';
        return;
    }
    container.innerHTML='';
    keys.forEach(key=>{
        const h=historico[key];
        if(!h) return;
        const saldoColor=h.saldo>=0?'var(--success)':'var(--danger)';
        const card=document.createElement('div');
        card.className='historico-card';
        card.innerHTML=`
          <div class="historico-mes-header" onclick="toggleHistMes('${key}',this)">
            <div><span class="hist-mes-nome">${MESES[h.month]}</span><span class="hist-mes-ano">${h.year}</span></div>
            <div class="hist-mes-right">
              <span class="hist-mes-saldo" style="color:${saldoColor}">${formatBRL(h.saldo)}</span>
              <span class="hist-mes-arrow">‚ñº</span>
            </div>
          </div>
          <div class="historico-body" id="hist-body-${key}">
            <div class="hist-resumo">
              <div class="hist-resumo-item"><div class="hist-resumo-label">Renda</div><div class="hist-resumo-val" style="color:var(--success)">${formatBRL(h.totalRenda)}</div></div>
              <div class="hist-resumo-item"><div class="hist-resumo-label">Gastos</div><div class="hist-resumo-val" style="color:var(--danger)">${formatBRL(h.totalDesp)}</div></div>
              <div class="hist-resumo-item"><div class="hist-resumo-label">Saldo</div><div class="hist-resumo-val" style="color:${saldoColor}">${formatBRL(h.saldo)}</div></div>
            </div>
            ${h.renda&&h.renda.length?`<div class="hist-section-title">Rendas</div>${h.renda.map(r=>`<div class="hist-item"><div class="hist-item-left"><div class="hist-item-cat">${r.cat}</div><div class="hist-item-desc">${r.desc||'‚Äî'}</div></div><span class="hist-item-pos">+${formatBRL(r.val)}</span></div>`).join('')}`:''}
            ${CAT_KEYS.filter(k=>k!=='economias').map(k=>{
              const rows=(h.gastos&&h.gastos[k]||[]).filter(r=>r.val>0);
              if(!rows.length) return '';
              return `<div class="hist-section-title">${CATEGORIAS[CAT_KEYS.indexOf(k)]}</div>${rows.map(r=>`<div class="hist-item"><div class="hist-item-left"><div class="hist-item-desc">${r.label}</div></div><span class="hist-item-neg">‚àí${formatBRL(r.val)}</span></div>`).join('')}`;
            }).join('')}
          </div>`;
        container.appendChild(card);
    });
}

window.toggleHistMes = function(key, header){
    const body=document.getElementById('hist-body-'+key);
    const isOpen=body.classList.contains('show');
    document.querySelectorAll('.historico-body').forEach(b=>b.classList.remove('show'));
    document.querySelectorAll('.historico-mes-header').forEach(h=>h.classList.remove('open'));
    if(!isOpen){ body.classList.add('show'); header.classList.add('open'); }
};

// ---- QUICK ADD MODAL ----
window.openAddModal = function(){
    document.getElementById('addModal').style.display='flex';
    document.getElementById('quickValue').value='';
    document.getElementById('quickCat').value='';
    document.getElementById('quickSub').innerHTML='<option value="" disabled selected>Item</option>';
    document.getElementById('quickSub').disabled=true;
    document.getElementById('quickPay').value='';
    setTimeout(()=>document.getElementById('quickValue').focus(),100);
};
window.closeAddModal = function(){
    const mc=document.querySelector('#addModal .modal-content');
    mc.style.animation='slideDownModal 0.3s forwards';
    setTimeout(()=>{ document.getElementById('addModal').style.display='none'; mc.style.animation=''; },300);
};
function updateQuickCatSelect(){
    const sel=document.getElementById('quickCat');
    const curVal=sel.value;
    sel.innerHTML='<option value="" disabled selected>Categoria</option>';
    CAT_KEYS.forEach((key,i)=>{ const o=document.createElement('option'); o.value=key; o.textContent=CATEGORIAS[i]; sel.appendChild(o); });
    if(curVal) sel.value=curVal;
}
window.updateSubcats = function(){
    const key=document.getElementById('quickCat').value;
    const sub=document.getElementById('quickSub');
    sub.innerHTML='<option value="" disabled selected>Item</option>';
    (gastosData[key]||[]).forEach((row,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=row.label||`Item ${i+1}`; sub.appendChild(o); });
    sub.disabled=false;
};
window.processAddExpense = function(){
    const val=parseMoney(document.getElementById('quickValue').value);
    const key=document.getElementById('quickCat').value;
    const idx=document.getElementById('quickSub').value;
    const pay=document.getElementById('quickPay').value;
    if(!val||!key||idx===''){alert('Preencha valor, categoria e item.');return;}
    const row=gastosData[key][idx];
    row.val+=val; if(pay) row.pay=pay;
    renderGastos();
    // Re-open category
    setTimeout(()=>{ document.getElementById('cat-'+key).classList.add('show'); document.getElementById('cat-hdr-'+key).classList.add('active'); },50);
    updateFlow(); saveAllData(); closeAddModal();
};

// ---- CALCULADORA ----
window.calculateProjection = function(){
    const getF=id=>{ let v=document.getElementById(id).value; return v?parseFloat(v.replace(',','.'))||0:0; };
    const P=parseMoney(document.getElementById('calcInit').value);
    const PMT=parseMoney(document.getElementById('calcMonth').value);
    const tempo=getF('tempo'), juros=getF('txJuros'), inflacao=getF('txInf');
    if(!tempo) return;
    let meses=document.getElementById('selTempo').value==='anos'?tempo*12:tempo;
    let i_m=document.getElementById('selJuros').value==='aa'?(Math.pow(1+juros/100,1/12)-1):(juros/100);
    let inf_m=document.getElementById('selInf').value==='aa'?(Math.pow(1+inflacao/100,1/12)-1):(inflacao/100);
    let labels=[],dTotal=[],dInvest=[],dReal=[],cTotal=P,cInvest=P,cReal=P;
    for(let m=0;m<=meses;m++){
        if(meses<=60||m%12===0||m===meses){
            labels.push(meses>60?`Ano ${Math.floor(m/12)}`:m);
            dTotal.push(cTotal); dInvest.push(cInvest); dReal.push(cReal);
        }
        if(m<meses){ cTotal=cTotal*(1+i_m)+PMT; cInvest+=PMT; cReal=(cReal*(1+i_m)/(1+inf_m))+PMT; }
    }
    document.getElementById('projContainer').style.display='block';
    document.getElementById('resFinal').textContent=formatBRL(cTotal);
    document.getElementById('resInvestido').textContent=formatBRL(cInvest);
    document.getElementById('resJuros').textContent=formatBRL(cReal-cInvest);
    document.getElementById('resReal').textContent=formatBRL(cReal);
    const ctx=document.getElementById('lineChart').getContext('2d');
    if(lineChart) lineChart.destroy();
    let grad=ctx.createLinearGradient(0,0,0,350); grad.addColorStop(0,'rgba(201,168,76,0.45)'); grad.addColorStop(1,'rgba(201,168,76,0.0)');
    lineChart=new Chart(ctx,{type:'line',data:{labels,datasets:[
        {label:'Patrim√¥nio',data:dTotal,borderColor:'#c9a84c',backgroundColor:grad,fill:true,tension:0.4},
        {label:'Investido',data:dInvest,borderColor:'#f0ede8',borderDash:[5,5],tension:0.4,pointRadius:0},
        {label:'Poder Compra',data:dReal,borderColor:'#4caf82',tension:0.4,pointRadius:0}
    ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
        plugins:{legend:{labels:{color:'#7a7880'}},tooltip:{callbacks:{label:c=>' '+c.dataset.label+': '+c.raw.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}}},
        scales:{x:{display:false},y:{grid:{color:'#1e1e24'},ticks:{color:'#4a4855',callback:v=>v>=1000000?(v/1000000).toFixed(1)+'M':v>=1000?(v/1000).toFixed(0)+'k':v}}}}
    });
    saveAllData();
};

// ---- LOAD MONTH DATA ----
function loadMonthData(){
    const key = monthKey();
    // If we have historico for this month, load it
    if(historico[key]){
        const h = historico[key];
        rendaItems = JSON.parse(JSON.stringify(h.renda||[]));
        gastosData = JSON.parse(JSON.stringify(h.gastos||{}));
        // Ensure all categories exist
        CAT_KEYS.forEach(k=>{ if(!gastosData[k]) gastosData[k]=[]; rowCounters[k]=gastosData[k].length; });
    } else {
        // Fresh month
        rendaItems = [];
        initGastosData();
    }
    renderGastos();
    renderRendaList();
    updateFlow();
}

// ---- SAVE / LOAD FIREBASE ----
let saveTimer;
window.saveAllData = function(){
    // Save current month into historico
    saveHistoricoSnapshot();

    const ativosVals = {};
    ['rf','reserva','rv','imoveis','cripto','internacional','outros_ativos','metaVal'].forEach(id=>{
        const el=document.getElementById(id); if(el) ativosVals[id]=parseMoney(el.value);
    });

    const calcVals = {};
    ['txJuros','txInf','tempo'].forEach(id=>{ const el=document.getElementById(id); if(el) calcVals[id]=el.value; });

    const payload = {
        historico: historico,
        ativos: ativosVals,
        calc: calcVals,
        currentYear, currentMonth,
        updatedAt: new Date().toISOString()
    };

    localStorage.setItem('clearview_bkp', JSON.stringify(payload));
    clearTimeout(saveTimer);
    setStatus('‚è≥','#4a4855');
    saveTimer = setTimeout(async()=>{
        try{
            await setDoc(doc(db,'clientes',CLIENT_ID,'dados','dashboard'), payload);
            setStatus('‚úì Nuvem','#4caf82');
            setTimeout(()=>setStatus('','#4a4855'),3000);
        }catch(e){
            console.error(e);
            setStatus('‚ö† Offline','#c9a84c');
        }
    },1500);
};

window.loadData = async function(){
    setStatus('‚è≥','#4a4855');
    let data = null;
    try{
        const snap = await getDoc(doc(db,'clientes',CLIENT_ID,'dados','dashboard'));
        if(snap.exists()) data=snap.data();
    }catch(e){ console.error(e); }

    if(!data){
        const local=localStorage.getItem('clearview_bkp');
        if(local) data=JSON.parse(local);
    }

    if(data){
        historico = data.historico||{};
        currentYear = data.currentYear||new Date().getFullYear();
        currentMonth = data.currentMonth!=null?data.currentMonth:new Date().getMonth();

        // Ativos
        const av=data.ativos||{};
        ['rf','reserva','rv','imoveis','cripto','internacional','outros_ativos','metaVal'].forEach(id=>fillInput(id,av[id]||0));

        // Calc
        const cv=data.calc||{};
        if(cv.txJuros) document.getElementById('txJuros').value=cv.txJuros;
        if(cv.txInf) document.getElementById('txInf').value=cv.txInf;
        if(cv.tempo) document.getElementById('tempo').value=cv.tempo;

        setStatus('‚úì','#4caf82');
        setTimeout(()=>setStatus('','#4a4855'),3000);
    } else {
        setStatus('','#4a4855');
    }

    renderMonthLabel();
    loadMonthData();
    initCharts();
    updateAssets();
};

function initCharts(){
    const ctxD=document.getElementById('assetsChart').getContext('2d');
    if(donutChart) donutChart.destroy();
    donutChart=new Chart(ctxD,{
        type:'doughnut',
        data:{
            labels:['RF','Reserva','RV','Im√≥veis','Cripto','Inter.','Outros'],
            datasets:[{data:[0,0,0,0,0,0,0],backgroundColor:['#c9a84c','#e8cc88','#f0ede8','#aaaaaa','#666677','#3a3a4a','#7a5c1e'],borderWidth:0}]
        },
        options:{responsive:true,maintainAspectRatio:false,
            plugins:{legend:{position:'bottom',labels:{color:'#7a7880',boxWidth:10,padding:8,font:{size:11}}},
            tooltip:{callbacks:{label:c=>' '+c.label+': '+c.raw.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}}}
        }
    });
}

// ---- NAV ----
window.openNav=()=>{ document.getElementById('mySidenav').style.width='240px'; document.getElementById('overlay').style.display='block'; };
window.closeNav=()=>{ document.getElementById('mySidenav').style.width='0'; document.getElementById('overlay').style.display='none'; };
window.resetFlow=()=>{
    if(!confirm('Zerar os gastos deste m√™s?')) return;
    CAT_KEYS.forEach(k=>gastosData[k].forEach(r=>{r.val=0;r.pay='';}));
    renderGastos(); updateFlow();
};

// ---- SPLASH + INIT ----
window.addEventListener('load', async()=>{
    // Show splash for minimum 3.2s then transition
    const minWait = new Promise(r=>setTimeout(r,3200));
    await Promise.all([minWait, loadData()]);

    const splash=document.getElementById('splash');
    splash.classList.add('exit');
    setTimeout(()=>{
        splash.style.display='none';
        const appEl=document.getElementById('app');
        appEl.classList.add('visible');
    },800);
});

</script>
</body>
</html>
